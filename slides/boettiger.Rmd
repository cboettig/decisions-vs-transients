---
title: "Conservation decision-making under long transients"
author: "Carl Boettiger"
institute: "UC Berkeley"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%"

---

background-image: url(img/royalsociety/penguin-swim.jpg)
background-position: center
background-size: 120%
class: center, top


```{r setup, include=FALSE}
knitr::opts_chunk$set(dev.args=list(bg="transparent"), 
                      echo = FALSE, message=FALSE, warning=FALSE,
                      fig.width=11, fig.height=6.5, cache = TRUE)

library(tidyverse)
library(ggthemes)

theme_set(
 theme_bw(base_size=26) + 
  theme(line = element_line(colour = "white", size = 1.5),
        rect = element_rect(fill = "transparent", colour = "white"),
        text = element_text(colour = "white"),
        axis.text = element_text(colour = "white"),
        axis.ticks = element_line(colour = "white", size = 1.5),
        panel.border = element_rect(colour = "white", size = 1.5),
        panel.background = element_rect(fill = "transparent"),
        plot.background = element_blank(), 
        legend.background = element_blank(), 
        legend.key = element_rect(fill = "transparent", colour = "transparent"), 
        strip.background = element_blank(),
        strip.text = element_text(colour = "white"),
        panel.grid = element_blank()))

source("../R/ghost.R")
```

# Decisions vs transient dynamics: what could possibly go wrong?

???

Image credit: [Royal Society Photo Competition](https://royalsociety.org/journals/publishing-activities/photo-competition/)



---
background-image: linear-gradient(to right, rgba(150, 150, 150, .1), rgba(150, 150, 150, .4)), url(img/city-mit-license.jpg)
background-size: 140%
class: center, top, inverse

# in an era of predictive black-box models...


---
background-image: linear-gradient(to right, rgba(150, 150, 150, .1), rgba(150, 150, 150, .4)), url(img/royalsociety/pensive-polarbear.jpg)
background-size: 120%
class: center, top, inverse

# ... a need for theory & process-based models


---
background-image: linear-gradient(to right, rgba(50, 50, 50, .6), rgba(50, 50, 50, .9)), url(img/royalsociety/whale-shark.jpg)
background-position: center
background-size: 120%
class: center, top, inverse

# Ghost Attractors

--

![](img/ghost-invert.png)

<br/>
Hastings et al. *Science* (2018)


---
layout: true
background-image: linear-gradient(to right, rgba(50, 50, 50, .6), rgba(50, 50, 50, .9)), url(img/royalsociety/snake.jpg)
background-size: 120%
background-position: center
class: left, top, inverse


---

# A look at the model


$$X_{t+1} = X_t + \underbrace{X_t r \left(1 -\frac{X_t}{K} \right)}_{\textrm{logistic growth}}  - \underbrace{\frac{a X_t ^ Q}{X_t^ Q + H ^ Q}}_{\textrm{saturating consumption}} + \underbrace{\xi_t X_t}_{\textrm{environmental noise}}$$

```{r fig.height=5.5}
p <- list(r = .05, K = 2, Q = 5, H = .38, sigma = .02, a=0.023, 
          N = 4e3, x0 = 0.2, N = 1e4)
theory(p) %>%
  ggplot(aes(x, y, col=curve)) +
  geom_line(lwd = 2)

```

---

## potential well diagram

```{r echo=FALSE}
theory(p) %>%
  ggplot(aes(x, potential)) + 
  geom_line(lwd = 2, col="white")

```

---

## deterministic skeleton timeseries 

```{r echo=FALSE}
det <- det_sim(may,p) %>% mutate(reps=1) %>% filter(t < 3000)
det  %>%
  ggplot(aes(t, x)) + 
  geom_line(lwd = 2, col="white")
```
---
layout: true
background-image: linear-gradient(to right, rgba(50, 50, 50, .7), rgba(50, 50, 50, .95)), url(img/royalsociety/gentoo-penguin.jpg)
background-size: 150%
class: center, top, inverse
background-position: left

# Stochastic simulations

---


```{r}
data <- vroom::vroom("../data/reps.csv.xz") %>% filter(t < 3000)
## get tail cases for comparison
ex <- data %>% group_by(reps) %>% summarise(ave = mean(x)) %>% arrange(ave)
lows <- ex %>% dplyr::slice(1:10) %>% pull(reps)
highs <- ex %>% dplyr::slice((n()-9):n()) %>% pull(reps)
```

```{r}
data %>% filter(reps == lows[[6]]) %>%
  ggplot(aes(t, x, group=reps)) + 
  geom_line(lwd=2, col="white") + 
  ylim(0,1.6)
```


---


```{r}

data %>% filter(reps == highs[[6]]) %>%
  ggplot(aes(t, x, group=reps)) + 
  geom_line(lwd=2, col="white") + 
  ylim(0,1.6)


```



---



```{r}
data %>% ggplot(aes(t,x, group=reps)) + 
  geom_line(alpha=0.02, color = "white")
```

---


```{r echo=FALSE}
mean <- data %>% group_by(t) %>% summarise(x = mean(x)) %>% mutate(reps = 1)
data %>% ggplot(aes(t,x, group=reps)) + 
  geom_line(alpha=0.02, color = "white") + 
  geom_line(data = mean, lwd=2, color = "white")
```



---
background-image: linear-gradient(to right, rgba(50, 50, 50, .7), rgba(50, 50, 50, .95)), url(img/royalsociety/gentoo-penguin-wtf.jpg)


```{r echo=FALSE}
data %>% 
  ggplot(aes(t,x, group=reps)) + 
  geom_line(alpha=0.02, color = "white") + 
  geom_line(data = mean, lwd = 2, color = "white") +
  geom_line(data = det, lwd = 2, color = rgb(.6, .6, 1)) 
```


---

**First-passage times**

```{r echo=FALSE}
## det equib
# data  %>% filter(t == max(t)) %>% pull(x) %>% mean() ## ~ 1.25

## First-passage time, tau
passage <- data %>% group_by(reps) %>% filter(x > 1.25) %>% summarise(tau = min(t))
det_tau <- det %>% group_by(reps) %>% filter(x > 1.25) %>% summarise(tau = min(t)) %>% pull(tau)
```

```{r}
passage %>% ggplot(aes(tau)) + 
  geom_histogram(binwidth = 200, fill=rgb(.9, .9, .9, .7)) + 
  geom_vline(aes(xintercept=det_tau), col="blue", lwd=2)
```


---
layout: false
background-image: linear-gradient(to right, rgba(50, 50, 50, .7), rgba(50, 50, 50, .95)), url(img/royalsociety/green-crested-lizard.jpg)
background-size: 110%
class: left, top, inverse
background-position: center

## Long transient dynamics can
## also create stochastic phenomena

--

- Emergent ensemble dynamics not predicted by the deterministic model

--

- But intuition is simple: noise helps 'jump' the ghost

--

- Noise creates dynamics that are deeply challenging for both inference & decision-making... 

---
background-image: linear-gradient(to right, rgba(150, 150, 150, .6), rgba(150, 150, 150, .85)), url(img/royalsociety/reef-shark.jpg)
background-size: 120%
class: top, inverse
background-position: center
layout: true


# Challenges to Model Inference


---

---

- Given time-series observations, can we distinguish ghost attractors from real attractors?

```{r}
discrete_sims <- read_csv("../data/discrete-sims.csv.xz")
discrete_sims %>% filter(series %in% c("1", "2")) %>% ggplot(aes(time,state)) + geom_line(col="white", lwd=1.5) + facet_wrap(~ series)
```

---
class: left

Hierarchical Bayesian estimation of stability using TensorFlow(R)

```r
library("greta")

mean <- x_t + r * x_t * (1 - x_t / K) - 
        a * x_t ^ q / (x_t ^ q + b ^ q)
distribution(x_t1) <- normal(mean, sigma_g * x_t)

a <- uniform(.25, .34) # Prior

draws <- mcmc(model(a), n_samples = 1000, warmup = 3000, chains = 4)
```



---
class: left

```{r fig.width=12.5, fig.height=7}
label <- c("no switch", "switch", "no ghost")

df <- c("../data/no_switches.csv.xz", "../data/switches.csv.xz", "../data/weak_ghost.csv.xz") %>%
  map_dfr(read_csv, .id = "timeseries") %>% 
  mutate(timeseries = label[as.integer(timeseries)])

inset <- discrete_sims %>% mutate(series = label[series]) %>% 
  ggplot(aes(time,state, col=series)) + 
  geom_line(lwd=1.5, show.legend = FALSE) + 
  ggplot2::scale_color_viridis_d() 



p1 <- df %>% 
  ggplot((aes(value, fill=timeseries))) + 
  geom_histogram(alpha=0.9) + 
  geom_vline(aes(xintercept=0.27, col = "no switch"), col= viridis::viridis_pal()(3)[1], lwd=2) + 
  geom_vline(aes(xintercept=0.28, col = "no ghost"), col = viridis::viridis_pal()(3)[2], lwd=2) + 
  ggplot2::scale_fill_viridis_d()

vp <- grid::viewport(width = 4, height = 0.8, x = 0.3, y = 0.7)

disp <- function(){
print(p1)
print(inset, vp = vp)
}

disp()
```


---
layout: true
background-image: linear-gradient(to right, rgba(50, 50, 50, .6), rgba(50, 50, 50, .9)), url(img/royalsociety/forest-fire.jpg)
background-size: 120%
class: center, top, inverse

# Descision Theory

---

### Management under uncertainty

---




---
layout: true
background-image: linear-gradient(to right, rgba(50, 50, 50, .6), rgba(50, 50, 50, .9)), url(img/royalsociety/pensive-polarbear.jpg)
background-size: 120%
class: center, top, inverse


---
background-image: linear-gradient(to right, rgba(50, 50, 50, .6), rgba(50, 50, 50, .9)), url(img/royalsociety/eagle-ray.jpg)
background-size: 120%
class: center, top, inverse







---
class: center, middle
background-image: linear-gradient(to right, rgba(50, 50, 50, .6), rgba(50, 50, 50, .9)), url(img/royalsociety/bohemian-waxwing.jpg)
background-size: 120%


# Acknowledgements

![](img/hastings.jpg) 

![](img/nimbios.jpg)

<!--
- Lizzie Wolkovich
- Henry Scharf
-->
